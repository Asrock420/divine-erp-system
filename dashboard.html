<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Divine ERP Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="layout">

  <div class="sidebar">
    <h2>Divine ERP</h2>
    <ul>
      <li onclick="showDashboard()">Dashboard</li>
      <li onclick="showLeads()">Leads</li>
    </ul>
    <button onclick="logout()">Logout</button>
  </div>

  <div class="main">

    <div id="dashboardSection">
      <h1>Dashboard</h1>
      <p id="userInfo"></p>
      <div class="card">
        <h3>Welcome</h3>
        <p>This is your Real Estate ERP Control Panel.</p>
      </div>
    </div>

    <div id="leadSection" style="display:none;">
      <h1>Leads Module</h1>

      <div class="card">
        <h3>Add New Lead</h3>

        <input type="text" id="client_name" placeholder="Client Name">
        <input type="text" id="phone" placeholder="Phone">
        <input type="text" id="project" placeholder="Project Name">
        <input type="text" id="unit_type" placeholder="Unit Type">
        <input type="number" id="budget" placeholder="Budget">
        <input type="text" id="source" placeholder="Lead Source">
        <input type="date" id="follow_up_date">
        <textarea id="remarks" placeholder="Remarks"></textarea>

        <label>Manual Assign (Optional)</label>
        <select id="assigned_to_dropdown">
          <option value="">Auto Assign (Round Robin)</option>
        </select>

        <button onclick="addLead()">Save Lead</button>
      </div>

      <div class="card">
        <h3>Lead List</h3>
        <table width="100%">
          <thead>
            <tr>
              <th>Name</th>
              <th>Phone</th>
              <th>Project</th>
              <th>Status</th>
              <th>Assigned</th>
            </tr>
          </thead>
          <tbody id="leadTable"></tbody>
        </table>
      </div>

    </div>

  </div>
</div>

<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbzvPMZKRx9kqG92dZ1XnfnaH6u2qEiiJInMq-OUB-0KMEyXllHkYh-XkjJYOypmbrn2/exec";

const user = JSON.parse(sessionStorage.getItem("user"));
if(!user){ window.location.href = "index.html"; }

document.getElementById("userInfo").innerText =
  "Logged in as: " + user.name + " (" + user.role + ")";

function logout(){
  sessionStorage.clear();
  window.location.href = "index.html";
}

function showDashboard(){
  document.getElementById("dashboardSection").style.display = "block";
  document.getElementById("leadSection").style.display = "none";
}

function showLeads(){
  document.getElementById("dashboardSection").style.display = "none";
  document.getElementById("leadSection").style.display = "block";
  loadLeads();
  loadSalesUsers();
}

function loadSalesUsers(){
  fetch(BASE_URL,{
    method:"POST",
    body: JSON.stringify({action:"getSalesUsers"})
  })
  .then(res=>res.json())
  .then(data=>{
    const dropdown = document.getElementById("assigned_to_dropdown");
    dropdown.innerHTML = '<option value="">Auto Assign (Round Robin)</option>';
    data.forEach(user=>{
      dropdown.innerHTML += `<option value="${user}">${user}</option>`;
    });
  });
}

function addLead(){

  fetch(BASE_URL,{
    method:"POST",
    body: JSON.stringify({
      action:"addLead",
      client_name: document.getElementById("client_name").value,
      phone: document.getElementById("phone").value,
      project: document.getElementById("project").value,
      unit_type: document.getElementById("unit_type").value,
      budget: document.getElementById("budget").value,
      source: document.getElementById("source").value,
      follow_up_date: document.getElementById("follow_up_date").value,
      remarks: document.getElementById("remarks").value,
      manual_assign: document.getElementById("assigned_to_dropdown").value,
      created_by: user.name
    })
  })
  .then(res=>res.json())
  .then(()=>{
    alert("Lead Saved");
    loadLeads();
  });
}

function loadLeads(){
  fetch(BASE_URL,{
    method:"POST",
    body: JSON.stringify({action:"getLeads"})
  })
  .then(res=>res.json())
  .then(data=>{
    const table = document.getElementById("leadTable");
    table.innerHTML="";
    data.forEach(lead=>{
      table.innerHTML+=`
        <tr>
          <td>${lead.client_name}</td>
          <td>${lead.phone}</td>
          <td>${lead.project}</td>
          <td>${lead.status}</td>
          <td>${lead.assigned_to}</td>
        </tr>`;
    });
  });
}
</script>

</body>
</html>